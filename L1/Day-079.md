# Day 79: Jenkins Deployment Job

## Scenario

The Nautilus development team had a meeting with the DevOps team where they discussed automating the deployment of one of their apps using Jenkins (the one in `Stratos Datacenter`). They want to auto deploy the new changes in case any developer pushes to the repository. As per the requirements mentioned below configure the required Jenkins job.
- Click on the `Jenkins` button on the top bar to access the Jenkins UI. Login using username `admin` and password `Adm!n321`.
- Similarly, click on the `Gitea` button on the top bar to access the `Gitea UI`. Login using username `sarah` and password `Sarah_pass123`. There under user sarah you will find a repository named `web` that is already cloned on `Storage server` under `/var/www/html`. sarah is a developer who is working on this repository.
- Install `httpd` (whatever version is available in the yum repo by default) and configure it to serve on port `8080` on All app servers. You can make it part of your Jenkins job or you can do this step manually on all app servers.
- Create a Jenkins job named `nautilus-app-deployment` and configure it in a way so that if anyone pushes any new change to the origin repository in `master` branch, the job should auto build and deploy the latest code on the `Storage server` under `/var/www/html` directory. Since `/var/www/html` on Storage server is shared among all apps.
Before deployment, ensure that the ownership of the `/var/www/html` directory is set to user `sarah`, so that Jenkins can successfully deploy files to that directory.

- SSH into `Storage Server` using `sarah` user credentials mentioned above. Under sarah user's home you will find a cloned Git repository named `web`. Under this repository there is an `index.html` file, update its content to `Welcome to the xFusionCorp Industries`, then push the changes to the origin into master branch. This push must trigger your Jenkins job and the latest changes must be deployed on the servers, also make sure it deploys the entire repository content not only `index.html` file.
- Click on the `App` button on the top bar to access the app, you should be able to see the latest changes you deployed. Please make sure the required content is loading on the main URL `https://<LBR-URL>` i.e there should not be any sub-directory like `https://<LBR-URL>/web` etc.


> **Note:**

- You might need to install some plugins and restart Jenkins service. So, we recommend clicking on `Restart Jenkins when installation is complete and no jobs are running` on plugin installation/update page i.e `update centre`. Also, Jenkins UI sometimes gets stuck when Jenkins service restarts in the back end. In this case, please make sure to refresh the UI page.
- Make sure Jenkins job passes even on repetitive runs as validation may try to build the job multiple times.
- Deployment related tasks should be done by `sudo` user on the destination server to avoid any permission issues so make sure to configure your Jenkins job accordingly. 
- For these kind of scenarios requiring changes to be done in a web UI, please take screenshots so that you can share it with us for review in case your task is marked incomplete. You may also consider using a screen recording software such as loom.com to record and share your work.
---

## Task

- Access the `Jenkins` via UI.
- Install Plugins.
- Install `httpd`.
- Create `pipeline`.


---

## Solution

### 1. Access Jenkin via UI

```bash
Click on Jenkins button.
```
---

### 2. Install Plugins
```bash
Goto >> Manage Jenkins >> Plugins >> Select ssh, git, Pipeline >> Click on Install.
```

---



### 3.Install httpd and change port 8080 on all app server.

```bash
 yum install httpd -y  
 sed -i 's/Listen 80/Listen 8080/g' /etc/httpd/conf/httpd.conf
 systemctl start httpd
```


---



### 4. Install Java in Storage Server ststor01 & update permission


```bash
dnf install fontconfig java-21-openjdk 
```
---

```bash
root@ststor01 ~]# cd /var/www
[root@ststor01 www]# ls -l 
total 4
drwxr-xr-x 3 sarah sarah 4096 Nov 11 15:26 html
[root@ststor01 www]# chown -R natasha html/
[root@ststor01 www]# ls -l 
total 4
drwxr-xr-x 3 natasha sarah 4096 Nov 11 15:26 html
```

---

### 5. Configure Node

<img width="2796" height="1326" alt="image" src="https://github.com/user-attachments/assets/f52f004e-cfe5-43c5-b625-38c7b3f40bd5" />


---

### 6. Create a Job

<img width="2846" height="1080" alt="image" src="https://github.com/user-attachments/assets/3e6f5780-fbbb-4fe2-a0c5-6e112c88afcf" />
<img width="2846" height="1080" alt="image" src="https://github.com/user-attachments/assets/01c6b95e-e294-496f-8a35-2e3ab2463180" />




```groovy
pipeline {
    agent { label 'ststor01' }

    parameters {
        string(name: 'BRANCH', defaultValue: 'master', description: 'Branch to deploy (master or feature)')
    }

    stages {
        stage('Deploy') {
            steps {
                script {
                    if (params.BRANCH == 'master' || params.BRANCH == 'feature') {
                        git branch: "${params.BRANCH}", url: "http://git.stratos.xfusioncorp.com/sarah/web_app.git"
                        sh 'cp -r * /var/www/html/'
                        echo "Deployed ${params.BRANCH} branch successfully."
                    } else {
                        error("Invalid branch: ${params.BRANCH}. Please specify master or feature.")
                    }
                }
            }
        }
    }
}



```

Run job



---

> **Result:**  Validate result.
By clicking on App
