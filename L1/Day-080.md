# Day 80: Jenkins Chained Builds

## Scenario

The DevOps team was looking for a solution where they want to restart Apache service on all app servers if the deployment goes fine on these servers in Stratos Datacenter. After having a discussion, they came up with a solution to use Jenkins chained builds so that they can use a downstream job for services which should only be triggered by the deployment job. So as per the requirements mentioned below configure the required Jenkins jobs.

- Click on the `Jenkins` button on the top bar to access the Jenkins UI. Login using username `admin` and password `Adm!n321`.
- Similarly, click on the `Gitea` button on the top bar to access the `Gitea UI`. Login using username `sarah` and password `Sarah_pass123`. There under user sarah you will find a repository named `web`. 
- Apache is already installed and configured on all app server so no changes are needed there. The doc root `/var/www/html` on all these app servers is shared among the Storage server under `/var/www/html` directory.
- Create a Jenkins job named `nautilus-app-deployment` and configure it to pull change from the `master` branch of `web` repository on `Storage server` under `/var/www/html` directory, which is already a local git repository tracking the origin web repository. Since `/var/www/html` on `Storage server` is a shared volume so changes should auto reflect on all apps.
- Create another Jenkins job named `manage-services` and make it a `downstream job` for `nautilus-app-deployment` job. Things to take care about this job are:
  - This job should restart `httpd` service on all app servers.
  - Trigger this job only if the `upstream job` i.e `nautilus-app-deployment` is stable.

> **Note:**

- You might need to install some plugins and restart Jenkins service. So, we recommend clicking on `Restart Jenkins when installation is complete and no jobs are running` on plugin installation/update page i.e `update centre`. Also, Jenkins UI sometimes gets stuck when Jenkins service restarts in the back end. In this case, please make sure to refresh the UI page.
- Make sure Jenkins job passes even on repetitive runs as validation may try to build the job multiple times.
- Deployment related tasks should be done by `sudo` user on the destination server to avoid any permission issues so make sure to configure your Jenkins job accordingly. 
- For these kind of scenarios requiring changes to be done in a web UI, please take screenshots so that you can share it with us for review in case your task is marked incomplete. You may also consider using a screen recording software such as loom.com to record and share your work.
---

## Task

- Access the `Jenkins` via UI.
- Install Plugins.
- Setup `Credential & system`.
- Create `pipeline`.
- Create `job`.


---

## Solution

### 1. Access Jenkin via UI

```bash
Click on Jenkins button.
```
---

### 2. Install Plugins
```bash
Goto >> Manage Jenkins >> Plugins >> Select ssh, Git, Pipeline >> Click on Install.
```

---



### 3.Install httpd and change port 8080 on all app server.

```bash
 yum install httpd -y  
 sed -i 's/Listen 80/Listen 8080/g' /etc/httpd/conf/httpd.conf
 systemctl start httpd
```


---



### 4. Create Key on Jenkin server and copy on storage server


```bash
jenkins@jenkins:~$ ssh-keygen -t rsa
jenkins@jenkins:~$ ssh-copy-id natasha@ststor01
[root@ststor01 ~]# cp -pr /home/natasha/.ssh/authorized_keys .ssh/

```
---

```bash
root@ststor01 ~]# cd /var/www
[root@ststor01 www]# ls -l 
total 4
drwxr-xr-x 3 sarah sarah 4096 Nov 11 15:26 html
[root@ststor01 www]# chown -R natasha html/
[root@ststor01 www]# ls -l 
total 4
drwxr-xr-x 3 natasha sarah 4096 Nov 11 15:26 html
```

---

### 5. Create Job

<img width="916" height="433" alt="image" src="https://github.com/user-attachments/assets/95caa690-98fe-4112-8cf0-8d7106e12163" />
<img width="919" height="373" alt="image" src="https://github.com/user-attachments/assets/55babae2-ad1d-4a4d-9479-208de96344fd" />

<img width="925" height="284" alt="image" src="https://github.com/user-attachments/assets/ff5e3dd5-5458-4519-b59c-3704dddf80b2" />

---

### 6. update index.html

```bash
thor@jumphost ~$ ssh sarah@ststor01
sarah@ststor01's password: 
[sarah@ststor01 ~]$ pwd
/home/sarah
[sarah@ststor01 ~]$ git clone http://git.stratos.xfusioncorp.com/sarah/web.git
[sarah@ststor01 ~]$ cd web/
[sarah@ststor01 web]$ ls
index.html
[sarah@ststor01 web]$ vi index.html 
[sarah@ststor01 web]$ cat index.html 
Welcome to the xFusionCorp Industries
[sarah@ststor01 web]$ git commit -am "index.html updated"
[sarah@ststor01 web]$ git push origin master

```

> In next run your page get populated with updated entry check same clicking on app.



---

> **Result:**  Validate result.
By clicking on App
