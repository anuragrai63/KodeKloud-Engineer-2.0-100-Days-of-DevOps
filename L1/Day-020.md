# Day 20: Configure Nginx + PHP-FPM Using Unix Sock

## Scenario
The Nautilus application development team plans to launch a new PHP-based application and wants to deploy it on the Nautilus infrastructure in Stratos DC. You have been tasked to set up the environment as per the requirements from the production support and development teams.

---

## Task Breakdown

### a. Install and Configure Nginx

1. **Install Nginx on app server 3:**
   ```bash
   sudo yum install nginx -y
   ```

2. **Configure Nginx to use port `8098` and set document root:**
   - Edit the default server block configuration:
     ```bash
     sudo vi /etc/nginx/conf.d/default.conf
     ```
   - Replace its contents with:
     ```nginx
     server {
         listen 8098;
         server_name stapp03;

         root /var/www/html;
         index index.php index.html;

         location / {
             try_files $uri $uri/ =404;
         }

         location ~ \.php$ {
             include fastcgi_params;
             fastcgi_pass unix:/var/run/php-fpm/default.sock;
             fastcgi_index index.php;
             fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
         }
     }
     ```

---

### b. Install PHP-FPM 8.3

1. **Enable appropriate repositories:**
   ```bash
   sudo dnf -y install epel-release
   sudo dnf -y install https://rpms.remirepo.net/enterprise/remi-release-9.rpm
   ```

2. **Reset and enable PHP 8.3 module:**
   ```bash
   sudo dnf -y module reset php
   sudo dnf -y module enable php:remi-8.3
   ```

3. **Install PHP-FPM 8.3 and common extensions:**
   ```bash
   sudo dnf -y install php-fpm php-cli php-common php-opcache php-mbstring php-xml php-gd php-intl php-mysqlnd php-zip
   ```

4. **Verify PHP version:**
   ```bash
   php -v    # Should display PHP 8.3.x
   ```

---

### c. Configure PHP-FPM to Use Custom Socket

1. **Create the socket directory (if not exists):**
   ```bash
   sudo mkdir -p /var/run/php-fpm
   ```

2. **Edit PHP-FPM pool configuration:**
   ```bash
   sudo vi /etc/php-fpm.d/www.conf
   ```
   - Update the following lines:
     ```
     listen = /var/run/php-fpm/default.sock
     listen.owner = nginx
     listen.group = nginx
     listen.mode = 0660
     ```

---

### d. Start and Enable Services

```bash
sudo systemctl enable php-fpm nginx
sudo systemctl start php-fpm nginx
```

---

### e. Test the Setup

- **From the jump host, run:**
  ```bash
  curl http://stapp03:8098/index.php
  ```
  - You should see the expected output from the PHP application.

---

**Note:**  
Two files, `index.php` and `info.php`, are already copied under `/var/www/html` as part of the setup. **Do not modify these files.**

---
